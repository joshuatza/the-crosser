name: Health Check

on:
  schedule:
    - cron: '*/30 * * * *' # Every 30 minutes
  workflow_dispatch: # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check all deployments
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          SITES=(
            "https://the-crosser.pages.dev|Cloudflare"
            "https://the-crosser.vercel.app|Vercel"
            "https://joshuatza.github.io/the-crosser/|GitHub Pages"
          )

          DOWN=""

          for SITE in "${SITES[@]}"; do
            URL="${SITE%%|*}"
            NAME="${SITE##*|}"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || echo "000")
            echo "$NAME ($URL): $STATUS"
            if [ "$STATUS" != "200" ]; then
              DOWN="$DOWN<li><strong>$NAME</strong> ($URL) ‚Äî HTTP $STATUS</li>"
            fi
          done

          if [ -n "$DOWN" ]; then
            echo "üö® Sites down, sending alert..."
            curl -s -X POST https://api.mailchannels.net/tx/v1/send \
              -H "Content-Type: application/json" \
              -d "{
                \"personalizations\": [{\"to\": [{\"email\": \"joshuatwycross@gmail.com\"}]}],
                \"from\": {\"email\": \"noreply@the-crosser.pages.dev\", \"name\": \"The Crosser\"},
                \"subject\": \"‚ö†Ô∏è The Crosser ‚Äî Site Down Alert\",
                \"content\": [{\"type\": \"text/html\", \"value\": \"<h2>Site Health Alert</h2><p>The following deployments are not responding:</p><ul>$DOWN</ul><p>Fallback order: Cloudflare ‚Üí Vercel ‚Üí GitHub Pages (no emails)</p>\"}]
              }"
            echo "Alert sent."
          else
            echo "‚úÖ All sites healthy."
          fi
