name: Health Check

on:
  schedule:
    - cron: '*/30 * * * *' # Every 30 minutes
  workflow_dispatch: # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Cloudflare Pages deployment
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          URL="https://the-crosser.pages.dev"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || echo "000")
          echo "Cloudflare Pages ($URL): $STATUS"

          if [ "$STATUS" != "200" ]; then
            echo "üö® Site down, sending alert..."
            curl -s -X POST https://api.resend.com/emails \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $RESEND_API_KEY" \
              -d "{
                \"from\": \"The Crosser <onboarding@resend.dev>\",
                \"to\": [\"joshuatwycross@gmail.com\"],
                \"subject\": \"‚ö†Ô∏è The Crosser ‚Äî Site Down Alert\",
                \"html\": \"<h2>Site Health Alert</h2><p>Cloudflare Pages ($URL) is not responding ‚Äî HTTP $STATUS</p>\"
              }"
            echo "Alert sent."
          else
            echo "‚úÖ Site healthy."
          fi
